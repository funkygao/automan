#!/usr/bin/php
<?php

require_once 'bootstrap.php';

/**
 * Automatically generate api doc according our customized phpdoc tags.
 *
 * Currently supported tags:
 * @In
 * @Out
 */
class Automan
{
    const SERVICE = 'Services\\';
    const ASSETS_BASE = 'http://dw.socialgamenet.com/';
    const URL_BASE = 'http://dw.socialgamenet.com/api/index.php';
    const URL_WEB_MOCK = 'http://localhost:9001';
    const VERBOSE = FALSE;
    const WEBMOCK_CONFIG = 'webmocker/automan.json';
    const TESTFILE = 'test.sh';
    const APIFILE = 'output/automan.html';

    private function _baseClassName($filename)
    {
        return substr(basename($filename), 0, -strlen('.php'));
    }

    private function _fullQualifiedClassName($filename)
    {
        return self::SERVICE . $this->_baseClassName($filename);
    }

    private function _handleAnnotationTag($filename, Annotation $tag)
    {
        if ($tag instanceof In) {
            return $this->_handleInputTag($filename, $tag);
        } elseif ($tag instanceof Out) {
            return $this->_handleOutputTag($filename, $tag);
        }
    }

    private function _handleInputTag($filename, In $tag)
    {
        return array(
            'input' => $tag->getJsonArray($filename),
        );

    }

    private function _handleOutputTag($filename, Out $tag)
    {
        return array(
            'output' => $tag->getJsonArray($filename),
        );
    }

    private function _normalizedController($baseClassname) 
    {
        $slot = strlen('Service');
        if (substr($baseClassname, -$slot) === 'Service') {
            return substr($baseClassname, 0, -$slot);
        }
        return $baseClassname;
    }

    private function _getApiUrl($filename, ReflectionMethod $method)
    {
        return self::URL_BASE;
    }

    public function parsePhpFile($filename)
    {
        require_once $filename;

        $clsname = $this->_fullQualifiedClassName($filename);
        if (self::VERBOSE) {
            echo "Parsing class $clsname..." . PHP_EOL;
        }

        $ret = array(
            'filename' => $filename,
        );
        $reflection = new ReflectionClass($clsname);
        // parse each method of the controller class
        foreach ($reflection->getMethods() as $method) {
            // handle this controller action
            $p = new ReflectionAnnotatedMethod($method->class, $method->name);
            $hasTag = FALSE;
            $inputOutput = array();
            foreach (array('In', 'Out') as $tagName) {
                $tag = $p->getAnnotation($tagName);
                if (!$tag) {
                    continue;
                }

                $hasTag = TRUE;
                if ($res = $this->_handleAnnotationTag($filename, $tag)) {
                    foreach ($res as $key => $val) {
                        $inputOutput[$key] = $val;
                    }
                }
            }

            if ($hasTag) {
                $controller = $this->_normalizedController($this->_baseClassName($filename));
                $ret['api'][] = array(
                    'controller' => $controller,
                    'action' => $method->name,
                    'url' => $this->_getApiUrl($filename, $method),
                    'io' => $inputOutput,
                );
            }
        }

        return $ret;
    }

    public function generateFrontendTestScript($parsedResult)
    {
        echo str_repeat("#", 10) . ' Frontend TEST ' . str_repeat("#", 10) . PHP_EOL;
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            if (!empty($api['io']['input'])) {
                $callAddr = 'curl -G ' . self::URL_WEB_MOCK . '/'
                    . $api['controller']
                    . '/'
                    . $api['action']
                    . " -d '";
                foreach ($api['io']['input'] as $name => $val) {
                    // TODO nested json tree
                    $callAddr .= 'params[' . $name . ']=' . urlencode($val) . '&';
                }
                $callAddr = rtrim($callAddr, '&');
                $callAddr .= "'";
                echo $callAddr . PHP_EOL;
            }
        }
        echo PHP_EOL;
    }

    public function generateBackendTestScript($parsedResult)
    {
        echo str_repeat("#", 10) . ' Backend TEST ' . str_repeat("#", 10) . PHP_EOL;
        $script = '';
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            if (!empty($api['io']['input'])) {
                $curl = 'curl -G ' . $api['url'] . " -d '";
                $curl .= 'class=' . $api['controller'];
                $curl .= '&method=' . $api['action'];
                foreach ($api['io']['input'] as $name => $val) {
                    // TODO nested json tree
                    $curl .= '&params[' . $name . ']=' . urlencode($val);
                }
                $curl .= "'";
                $script .= $curl . PHP_EOL;
                $script .= 'echo' . PHP_EOL;
                echo $curl . PHP_EOL;
            }
        }
        echo PHP_EOL;
        file_put_contents(self::TESTFILE, $script);
        echo self::TESTFILE . ' generated!' . PHP_EOL;
    }

    public function generateApiDoc($parsedResult)
    {
        if (empty($parsedResult['api'])) {
            return;
        }

        `mkdir -p output`;
        \Utils\TemplateEngine::set(new Mustache_Engine(array(
            'cache' => '/tmp/',
            'cache_file_mode' => 0666,
            'loader' => new Mustache_Loader_FilesystemLoader('template/'),
            'partials_loader' => new Mustache_Loader_FilesystemLoader('template/Partials/'),
            'helpers' => array('i18n' => function($text) {
            }),
            'escape' => function($value) {
                return htmlspecialchars($value, ENT_COMPAT, 'utf-8');
            },
                'charset' => 'ISO88591',
                'logger' => new Mustache_Logger_StreamLogger('php://stderr'),
                'strict_callables' => true,
            )));
        $html = \Utils\TemplateEngine::fetch('automan', 
            array(
                'api' => $parsedResult['api'], 
                'assets' => self::ASSETS_BASE, 
                'ngName'=>'ApiExplorerModule',
                'title' => 'ApiDoc',
            )
        );
        file_put_contents(self::APIFILE, $html);
        echo self::APIFILE . ' generated!' . PHP_EOL;

        return;
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            echo str_repeat("*", 60) . PHP_EOL;
            echo "\t\t" . $api['controller'] . ":" . $api['action'] . PHP_EOL;
            echo str_repeat("*", 60) . PHP_EOL;
            if (!empty($api['io']['input'])) {
                echo str_repeat('=', 10) . "> Input " . PHP_EOL;
                echo json_encode($api['io']['input'], JSON_PRETTY_PRINT), PHP_EOL;
            }
            echo PHP_EOL;
            if (!empty($api['io']['output'])) {
                echo '<' . str_repeat('=', 10) . " Output " . PHP_EOL;
                echo json_encode($api['io']['output'], JSON_PRETTY_PRINT), PHP_EOL;
            }

            echo PHP_EOL;
        }
    }

    public function generateWebMockerData($parsedResult)
    {
        $fp = fopen(self::WEBMOCK_CONFIG, 'w');
        fwrite($fp, json_encode($parsedResult, JSON_PRETTY_PRINT));
        fclose($fp);
        echo self::WEBMOCK_CONFIG, " genereted!" . PHP_EOL;
        $reloadWebMocker = "kill -HUP `pgrep webmocker`";
        `$reloadWebMocker`;
    }

}

function showHelp() {
    global $argv;
    echo "Usage: " . $argv[0] . " filename [filename]\n";
}

function main() {
    global $argv;
    ini_set('register_argc_argv', 'On');
    if (count($argv) == 1) {
        showHelp();
        exit(0);
    }

    $man = new Automan();
    foreach ($argv as $idx => $filename) {
        if ($idx == 0) {
            continue;
        }

        $result = $man->parsePhpFile($filename);
        if (empty($result['api'])) {
            echo "Found no @In/@Out tags!" . PHP_EOL;
            return;
        }

        $man->generateBackendTestScript($result);
        $man->generateFrontendTestScript($result);
        $man->generateApiDoc($result);
        $man->generateWebMockerData($result);
    }
}

main();
