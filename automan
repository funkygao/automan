#!/usr/bin/php
<?php

require_once 'bootstrap.php';

/**
 * Automatically generate api doc according our customized phpdoc tags.
 *
 * Currently supported tags:
 * @In
 * @Out
 */
class Automan
{
    const SERVICE = 'Services\\';
    const URL_BASE = 'http://dw.socialgamenet.com/api/index.php';
    const URL_WEB_MOCK = 'http://localhost:9002';
    const VERBOSE = FALSE;
    const WEBMOCK_CONFIG = 'webmocker/automan.json';
    const TESTFILE = 'test.sh';

    private function _baseClassName($filename)
    {
        return substr(basename($filename), 0, -strlen('.php'));
    }

    private function _fullQualifiedClassName($filename)
    {
        return self::SERVICE . $this->_baseClassName($filename);
    }

    private function _handleAnnotationTag($filename, Annotation $tag)
    {
        if ($tag instanceof In) {
            return $this->_handleInputTag($filename, $tag);
        } elseif ($tag instanceof Out) {
            return $this->_handleOutputTag($filename, $tag);
        }
    }

    private function _handleInputTag($filename, In $tag)
    {
        return array(
            'input' => $tag->getJsonArray($filename),
        );

    }

    private function _handleOutputTag($filename, Out $tag)
    {
        return array(
            'output' => $tag->getJsonArray($filename),
        );
    }

    private function _normalizedController($baseClassname) 
    {
        $slot = strlen('Service');
        if (substr($baseClassname, -$slot) === 'Service') {
            return substr($baseClassname, 0, -$slot);
        }
        return $baseClassname;
    }

    private function _getApiUrl($filename, ReflectionMethod $method)
    {
        return self::URL_BASE;
    }

    public function parsePhpFile($filename)
    {
        require_once $filename;

        $clsname = $this->_fullQualifiedClassName($filename);
        if (self::VERBOSE) {
            echo "Parsing class $clsname..." . PHP_EOL;
        }

        $ret = array(
            'filename' => $filename,
        );
        $reflection = new ReflectionClass($clsname);
        // parse each method of the controller class
        foreach ($reflection->getMethods() as $method) {
            // handle this controller action
            $p = new ReflectionAnnotatedMethod($method->class, $method->name);
            $hasTag = FALSE;
            $inputOutput = array();
            foreach (array('In', 'Out') as $tagName) {
                $tag = $p->getAnnotation($tagName);
                if (!$tag) {
                    continue;
                }

                $hasTag = TRUE;
                if ($res = $this->_handleAnnotationTag($filename, $tag)) {
                    foreach ($res as $key => $val) {
                        $inputOutput[$key] = $val;
                    }
                }
            }

            if ($hasTag) {
                $controller = $this->_normalizedController($this->_baseClassName($filename));
                $ret['api'][] = array(
                    'controller' => $controller,
                    'action' => $method->name,
                    'url' => $this->_getApiUrl($filename, $method),
                    'io' => $inputOutput,
                );
            }
        }

        return $ret;
    }

    public function generateFrontendTestScript($parsedResult)
    {
        echo str_repeat("#", 10) . ' Frontend TEST ' . str_repeat("#", 10) . PHP_EOL;
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            if (!empty($api['io']['input'])) {
                $callAddr = 'curl ' . self::URL_WEB_MOCK . '/'
                    . $api['controller']
                    . '/'
                    . $api['action']
                    . " -d '"
                ;
                foreach ($api['io']['input'] as $name => $val) {
                    // TODO nested json tree
                    $callAddr .= '&params[' . $name . ']=' . urlencode($val);
                }
                $callAddr .= "'";
                echo $callAddr . PHP_EOL;
            }
        }
        echo PHP_EOL;
    }

    public function generateBackendTestScript($parsedResult)
    {
        echo str_repeat("#", 10) . ' Backend TEST ' . str_repeat("#", 10) . PHP_EOL;
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            if (!empty($api['io']['input'])) {
                $curl = 'curl -G ' . $api['url'] . " -d '";
                $curl .= 'class=' . $api['controller'];
                $curl .= '&method=' . $api['action'];
                foreach ($api['io']['input'] as $name => $val) {
                    // TODO nested json tree
                    $curl .= '&params[' . $name . ']=' . urlencode($val);
                }
                $curl .= "'";
                echo $curl . PHP_EOL;
            }
        }
        echo PHP_EOL;
    }

    public function generateApiDoc($parsedResult)
    {
        foreach ($parsedResult['api'] as $api) {
            if (!is_array($api)) {
                throw Exception("invalid parsed result");
            }

            echo str_repeat("*", 60) . PHP_EOL;
            echo "\t\t" . $api['controller'] . ":" . $api['action'] . PHP_EOL;
            echo str_repeat("*", 60) . PHP_EOL;
            if (!empty($api['io']['input'])) {
                echo str_repeat('=', 10) . "> Input " . PHP_EOL;
                echo json_encode($api['io']['input'], JSON_PRETTY_PRINT), PHP_EOL;
            }
            echo PHP_EOL;
            if (!empty($api['io']['output'])) {
                echo '<' . str_repeat('=', 10) . " Output " . PHP_EOL;
                echo json_encode($api['io']['output'], JSON_PRETTY_PRINT), PHP_EOL;
            }

            echo PHP_EOL;
        }
    }

    public function generateWebMockerData($parsedResult)
    {
        $fp = fopen(self::WEBMOCK_CONFIG, 'w');
        fwrite($fp, json_encode($parsedResult, JSON_PRETTY_PRINT));
        fclose($fp);
        echo self::WEBMOCK_CONFIG, " genereted!" . PHP_EOL;
    }

}

function showHelp() {
    global $argv;
    echo "Usage: " . $argv[0] . " filename [filename]\n";
}

function main() {
    global $argv;
    ini_set('register_argc_argv', 'On');
    if (count($argv) == 1) {
        showHelp();
        exit(0);
    }

    $man = new Automan();
    foreach ($argv as $idx => $filename) {
        if ($idx == 0) {
            continue;
        }

        $result = $man->parsePhpFile($filename);
        if (empty($result['api'])) {
            echo "Found no @In/@Out tags!" . PHP_EOL;
            return;
        }
        $man->generateBackendTestScript($result);
        $man->generateFrontendTestScript($result);
        $man->generateApiDoc($result);
        $man->generateWebMockerData($result);
    }
}

main();
